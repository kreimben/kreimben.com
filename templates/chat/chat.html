{% extends 'base.html' %}

{% block title %}
    Anonymous Chat
{% endblock %}

{% block content %}
    <div>
        <div>
            Anonymous Chat
        </div>
        <div>
            <div id="loading_spin" class="d-flex justify-content-center mt-3">
                <div class="spinner-grow" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="failed_info"></div>

            <div id="chat_box" class="container text-center"></div>

            <div>
                <div id="loading_spin_input" class="spinner-grow" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <input type="text" id="chat_input" style="margin-bottom: 30px;width:80%;"
                       onkeydown="if(window.event.keyCode==13){send_message();clear_input();}">
                <input type="button" id="send_button" value="Send" onclick="send_message();clear_input();"/>
            </div>
        </div>
    </div>

    <style>
        #chat_box {
            overflow-y: scroll;
            width: auto;
            height: 65vh;
            margin-bottom: 30px;
            margin-top: 30px;
            background-image: url('https://cdn.britannica.com/57/75757-050-122EC2ED/Changgyong-Palace-background-Seoul.jpg');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            -ms-overflow-style: none; /* 인터넷 익스플로러 */
            scrollbar-width: none; /* 파이어폭스 */
        }

        #chat_box::-webkit-scrollbar {
            display: none; /* 크롬, 사파리, 오페라, 엣지 */
        }

        .k_chat_box {
            /* From https://css.glass */
            background: rgba(225, 210, 48, 0.18);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8.4px);
            -webkit-backdrop-filter: blur(8.4px);
            border: 1px solid rgba(225, 210, 48, 0.58);
        }
    </style>

    {#    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>#}

    <script>
        let ws = new WebSocket("{{ websocket_endpoint }}");

        ws.onopen = () => {
            ws.send('{{ ip|escapejs }}');
            loading_spin.parentNode.removeChild(loading_spin);
        }

        ws.onerror = (err) => {
            console.log(`err: ${err}`)
        }

        if (ws.readyState !== WebSocket.OPEN) {
            console.error(`websocket connection is not opened.`);
        }

        const user_input = document.getElementById('chat_input');
        const chat_box = document.getElementById('chat_box');
        const failed_info = document.getElementById('failed_info');
        const loading_spin = document.getElementById('loading_spin');
        const send_button = document.getElementById('send_button');
        const loading_spin_input = document.getElementById('loading_spin_input');

        loading_spin_input.style.visibility = 'hidden';

        let chatter_id = '';
        let hashed_value = '';

        const send_message = () => {
            if (chatter_id !== '' && hashed_value !== '') {
                make_disable();
                ws.send(JSON.stringify({
                    'message': user_input.value,
                    'hashed_value': hashed_value,
                    'chatter_id': chatter_id
                }));
                make_enable();
            }
        }

        const make_disable = () => {
            user_input.disabled = true;
            send_button.disabled = true;
            loading_spin_input.style.visibility = 'visible';
        }

        const make_enable = () => {
            user_input.disabled = false;
            send_button.disabled = false;
            loading_spin_input.style.visibility = 'hidden';
        }

        const make_text_box = (chat) => {
            let result;
            if (chat['hashed_value'] === 'System') {
                result += `<div class='row justify-content-center'>
                <div class="k_chat_box m-3 col-6">`;
            } else if (chat['hashed_value'] === hashed_value) {
                result += `<div class='row justify-content-end'>
                <div class="k_chat_box m-3 col-6">`;
            } else {
                result += `<div class='row justify-content-start'>
                <div class="k_chat_box m-3 col-6">`;
            }

            result += `<strong>[${chat["hashed_value"]}] ${chat["hashed_value"] === hashed_value ? "(me)" : ""}</string>
                <p>${chat["message"]}</p>
                <p>${chat["time"]}</p>
                </div>
                </div>
            `;

            chat_box.innerHTML += result;
        }

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data["success"]) {
                chatter_id = data['chatter_id'];
                hashed_value = data['hashed_value'];
            } else {
                make_text_box(data);
                chat_box.scrollTop = chat_box.scrollHeight;
            }
        }

        const clear_input = () => {
            user_input.value = '';
        }
    </script>
{% endblock %}